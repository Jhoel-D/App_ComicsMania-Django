{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h1 class="card-title"><i class="fas fa-shopping-cart"></i> Detalles de la Orden</h1>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong><i class="fas fa-id-card"></i> ID de Orden:</strong> {{ order.id }}</p>
                            <p><strong><i class="fas fa-info-circle"></i> Estado:</strong> {{ order.status }}</p>
                            <p><strong><i class="fas fa-dollar-sign"></i> Total de la Orden:</strong> {{ order.total_price }} Bs</p>
                        </div>
                        <div class="col-md-4">
                            <!-- Formulario para datos de envío -->
                            <form id="data-form" method="post" action="{% url 'order_detail' order_id=order.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="update-form"> 
                                <div class="form-group bg-light">
                                    <label for="shipping_address"><i class="fas fa-map-marker-alt"></i> Dirección de Envío</label>
                                    <input class="form-control" type="text" name="shipping_address" value="{{ order.shipping_address }}" placeholder="Incluye el # de puerta">
                                </div>
                                <div class="form-group bg-light">
                                    <label for="first_name"><i class="fas fa-user"></i> Primer Nombre</label>
                                    <input class="form-control" type="text" name="first_name" value="{{ order.first_name }}" placeholder="Ingrese su primer nombre">
                                </div>
                                <div class="form-group bg-light">
                                    <label for="last_name"><i class="fas fa-user"></i> Primer Apellido</label>
                                    <input class="form-control" type="text" name="last_name" value="{{ order.last_name }}" placeholder="Ingrese su primer apellido">
                                </div>
                                <div class="form-group bg-light">
                                    <label for="country"><i class="fas fa-globe-americas"></i> País</label>
                                    <select id="country" name="country" class="form-control">
                                        {% for code, country_name in order.COUNTRY_CHOICES %}
                                            <option value="{{ code }}" {% if code == order.country %} selected {% endif %}>{{ country_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group bg-light">
                                    <label for="city"><i class="fas fa-building"></i> Departamento: </label>
                                    <select id="city" name="city" class="form-control">
                                        {% for code, city in order.BOLIVIAN_DEPARTMENTS %}
                                            <option value="{{ code }}" {% if code == order.city %} selected {% endif %}>{{ city }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group bg-light">
                                    <label for="zone"><i class="fas fa-map-pin"></i> Zona</label>
                                    <input class="form-control" type="text" name="zone" value="{{ order.zone }}" placeholder="Zona">
                                </div>
                                <button id="save-data-button" class="btn btn-primary" type="submit"><i class="fas fa-check"></i> Guardar Datos</button>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <!-- Formulario para método de pago -->
                            <form id="payment-form" method="post" action="{% url 'order_detail' order_id=order.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="payment-form"> 
                                <div class="form-group bg-light">
                                    <label for="payment_method"><i class="fas fa-credit-card"><strong><i class="fas fa-card"></i> REALIZAR EL PAGO POR::</strong></i></label>
                                    
                                    <div>
                                        {% for method in order.PAYMENT_CHOICES %}
                                        <div class="form-check" style="margin-bottom: 10px;">
                                            <input class="form-check-input" type="radio" name="payment_method" value="{{ method.0 }}" id="{{ method.0 }}" onchange="togglePaymentContainer('{{ method.0 }}')">
                                            <label class="form-check-label" for="{{ method.0 }}">
                                                {% if method.0 == 'PayPal' %}
                                                    <img src="{% static 'img/PayPal.png' %}" alt="PayPal" style="width: 100px; height: auto; margin-right: 10px;">
                                                    <div id="paypal-container" style="display: none;">
                                                        <!-- Contenido de PayPal -->
                                                        <div id="paypal-button-container"></div>
                                                    </div>
                                                {% elif method.0 == 'Mercado Libre' %}
                                                    <img src="{% static 'img/mercado_l.png' %}" alt="Mercado Libre" style="width: 100px; height: auto; margin-right: 10px;">
                                                {% else %}
                                                    <i class="fas fa-credit-card"></i> {{ method.1 }}
                                                {% endif %}
                                            </label>
                                        </div>
                                    {% endfor %}
                                    </div>
                                </div>
                                <div class="form-group">
                                   <button id="confirm-payment-button" class="btn btn-primary" type="submit" style="display: none;"><i class="fas fa-check"></i> Confirmar Pago</button>

                                    <button id="cancel-order-button" class="btn btn-secondary" type="button"><i class="fas fa-times"></i> No comprar Orden</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para manejar la cancelación de la orden -->
<script>
    document.getElementById("cancel-order-button").addEventListener("click", function() {
        if (confirm("¿Estás seguro de que deseas cancelar esta orden?")) {
            // Enviar una solicitud POST para cancelar la orden
            fetch("{% url 'cancel_order' order_id=order.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => {
                if (response.ok) {
                    // Redirigir o hacer algo en caso de éxito
                    alert("Orden cancelada correctamente");
                    // Por ejemplo, redirigir a la página principal
                    window.location.href = "{% url 'home' %}";
                } else {
                    // Manejar errores de cancelación de orden
                    alert("Error al cancelar la orden");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error al cancelar la orden");
            });
        }
    });
</script>

<script>
    // Función para mostrar u ocultar el contenedor de PayPal y otros métodos de pago
    function togglePaymentContainer(paymentMethod) {
        var paypalContainer = document.getElementById('paypal-container');
        
        if (paymentMethod === 'PayPal') {
            paypalContainer.style.display = 'block';
        } else {
            paypalContainer.style.display = 'none';
        }
    }
</script>

<script src="https://www.paypal.com/sdk/js?client-id=ASN1mNwEDNB287Si0Ock9BSi8KWcMOk0ileCfImWBlekUoZGbgx0dcRt6LtJqtjlJeS2vXufxHVkAYIT"></script>
<script>
    // Convertir el monto a dólares usando la tasa de cambio (supongamos 1 USD = 6.9 BOB)
    var totalInBob = parseFloat("{{ order.total_price }}");
    var exchangeRate = 6.9; // Supongamos que 1 USD = 6.9 BOB
    var totalInUsd = totalInBob / exchangeRate;

    paypal.Buttons({
        createOrder: function (data, actions) {
            return actions.order.create({
                purchase_units: [
                    {
                        amount: {
                            currency_code: 'USD', // Monto en dólares
                            value: totalInUsd.toFixed(2), // Redondeamos a 2 decimales
                        },
                    },
                ],
            });
        },
        onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
                // Envía el formulario para guardar la orden
                document.getElementById("payment-form").submit();
                // Muestra un mensaje de alerta cuando se completa la transacción
                alert("Transacción completada por " + details.payer.name.given_name);
                // Redirecciona a la página de inicio después de completar la transacción
                window.location.href = "{% url 'home' %}";
            });
        },
    }).render("#paypal-button-container");

    // Agregamos un evento de clic al botón de PayPal para desencadenar la acción del formulario
    document.getElementById("paypal-button-container").addEventListener("click", function() {
        // Simulamos un clic en el botón de confirmación del formulario
        document.getElementById("confirm-payment-button").click();
    });
</script>

{% endblock %}
